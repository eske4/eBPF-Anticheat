# src/eBPF_prog/CMakeLists.txt
set(EBPF_PROGRAMS kmod_tracker.bpf.c mem_access.bpf.c)
set_source_files_properties(${EBPF_PROGRAMS} PROPERTIES LANGUAGE C)

# 1. Keep the library so the LSP/clangd works!
add_library(ebpf_targets OBJECT ${EBPF_PROGRAMS})
target_link_libraries(ebpf_targets PRIVATE bpf_headers)
target_compile_options(
  ebpf_targets
  PRIVATE -target
          bpf
          -O2
          -g
          -x
          c
          -Wno-unused-parameter
          -std=gnu17
          # This is the critical line for Kprobes:
          -D__TARGET_ARCH_x86)
# 1. Map skeletons to their specific object files

foreach(src ${EBPF_PROGRAMS})
  # 1. This correctly turns "kmod_tracker.bpf.c" into "kmod_tracker"
  string(REPLACE ".bpf.c" "" name ${src})

  # Path to the .o file generated by the OBJECT library
  set(OBJ_FILE
      "${CMAKE_CURRENT_BINARY_DIR}/CMakeFiles/ebpf_targets.dir/${src}.o")
  set(SKEL_H "${SKEL_OUT_DIR}/${name}.skel.h")

  add_custom_command(
    OUTPUT ${SKEL_H}
    # 1. ADD 'name ${name}' HERE. This forces the clean naming in the header
    COMMAND bpftool gen skeleton ${OBJ_FILE} name ${name} > ${SKEL_H}
    DEPENDS ebpf_targets ${OBJ_FILE}
    VERBATIM
    COMMENT "Generating clean skeleton for ${name}")

  add_custom_target(${name}_skel ALL DEPENDS ${SKEL_H})
endforeach()
